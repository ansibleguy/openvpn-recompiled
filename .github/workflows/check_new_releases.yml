---

name: Check for new releases

on:
  schedule:
    - cron: '20 19 * * *'

jobs:
  check:
    name: Checking for new OpenVPN releases
    runs-on: ubuntu-latest
    outputs:
      releases: "${{ steps.check_job.outputs.json }}"

    steps:
    - uses: actions/checkout@v3

    - name: Check for new releases
      run: |
        releases=$(python3 scripts/get_new_releases.py)
        echo "::set-output name=json::${releases}"
      shell: bash
      id: check_job

  release:
    name: Creating missing releases
    needs: [check]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        value: "${{ fromJson(needs.check.outputs.releases) }}"

    steps:
      - name: "Create Release ${{ matrix.value }}"
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          tag_name: "${{ matrix.value }}"
          release_name: "${{ matrix.value }}"
          draft: false
          prerelease: false

      - name: "Create Release ${{ matrix.value }}"
        uses: ./.github/workflows/build.yml
        with:
          version: "${{ matrix.value }}"
